<!DOCTYPE html>
<html>
<head></head>
<body>
	
  <h1 style='text-align: center; margin-bottom: -35px;'>Image labeling webapp</h1>
  <br><br>
	
	
<!-- OCR webapp -->
   <h2 id="select_model" style='text-align: left; display:none'>Write a captial letter or number in the box, click the button to classify</h2>
   
		
<!-- Once image and model are selected, make image appear in canvas and run model -->
   <div style="width:100%;height:100%;position:absolute;vertical-align:middle;text-align:left;">
        <canvas id="canvasId" width="224" height="224" style="display:block"></canvas>
    <div>

      <div style="width:100%;height:100%;position:absolute;vertical-align:middle;text-align:left;">
        <button id="run_object_detection" onclick="run_object_detection()" style="display:block">run_object_detection</button>
    <div>

    <div id="output" style="font-family:courier;font-size:24px;height:300px"></div>

	    
<style>
      canvas {border: 1px solid black;}
    </style>
  
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest"></script>
<!-- DOES NOT WORK <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script> -->
<!--  <script src="https://cdn.jsdelivr.net/npm/@koush/coco-ssd@2.2.15/dist/index.min.js"></script> -->
<script src="https://cdn.jsdelivr.net/npm/@microduino/tf-coco-ssd@1.0.3-alpha/dist/coco-ssd.min.js"></script>  <!-- WORKS -->

  
<script>
  // https://developer.mozilla.org/en-US/docs/Web/API/CanvasRenderingContext2D/drawImage
  var canvasElement = document.getElementById("canvasId");
  const ctx = canvasElement.getContext("2d");

  // -------------------------------------------------
	
  const outp = document.getElementById('output');

  // -------------------------------------------------

  // https://developer.mozilla.org/en-US/docs/Web/API/MouseEvent/clientX
  // eventlistener for mousedown
  const selectCanvas = document.getElementById('canvasId');
	
  selectCanvas.addEventListener("mousedown", (e) => {
     ctx.lineTo(e.offsetX, e.offsetY);
     ctx.lineWidth = 10;  // thickness of line
     ctx.beginPath();
     selectCanvas.addEventListener("mousemove", createlines, false);
  }, false);
	


  var createlines = function(e){

	  // https://developer.mozilla.org/en-US/docs/Web/API/MouseEvent/pageX
	  // returns the X (horizontal) coordinate (in pixels) at which the mouse was clicked, relative to the left edge of the entire document (close)
	  // ctx.lineTo(e.pageX-e.offsetX, e.pageY-e.offsetY);
	  // OR
	  // the horizontal/vertical coordinate (offset) of the mouse pointer in screen coordinates. (not correct)
	  // ctx.lineTo(e.screenX, e.screenY);
	  // OR
	  // the horizontal coordinate within the application's viewport at which the event occurred (as opposed to the coordinate within the page). (close)
	  // ctx.lineTo(e.clientX, e.clientY);
	  // OR
	  // provides the offset in the X coordinate of the mouse pointer between that event and the padding edge of the target node. (CORRECT!!)
	  ctx.lineTo(e.offsetX, e.offsetY);
	  
	  ctx.strokeStyle = "green";  // color of line
	  ctx.stroke();
  };
	
  // -------------------------------------------------
	
  selectCanvas.addEventListener("mouseup", () => {

	  selectCanvas.removeEventListener('mousemove', createlines, false);

	  const img = new Image();
  	  img.onload = () => {
	  ctx.drawImage(img, 0, 0, 224, 224);
	  };

  }, false);

  // -------------------------------------------------
	
  async function run_object_detection(){

	  try {
      
      await cocoSsd.load().then(model => {

        // ----------------------
        // Test if it has received the image

        const image = new Image();
        // image.src = 
        ctx.drawImage(image, 0,0);
        var tensor_image = tf.browser.fromPixels(image); // This is size 224,224,3

        // OR
	
        // const tensor_image = tf.browser.fromPixels(canvasElement); // This is size 224,224,3
        // ----------------------

        //const image_4D = tensor_image.expandDims(0); // This is size 1,224,224,3

        const image_4D_int = tf.cast(tensor_image, 'int32')
	// Error: The dtype of dict['image_tensor'] provided in model.execute(dict) must be int32, but was float32

        // ----------------------

        // document.getElementById("outData").innerHTML = tf.max(tensor_image);

        // Give image to model
        model.detect(image_4D_int).then(predictions => { outp.innerHTML = predictions; }); 
      
      });

    } catch (error) {
      outp.innerHTML = error
    }

  }

  // -------------------------------------------------



	

</script>
</body>
</html>
